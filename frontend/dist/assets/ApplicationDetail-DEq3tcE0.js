import{j as e,s as t,d as v,A as ge,i as he,a as ye,u as fe,e as je,b as be,f as ve,g as q,L as Y}from"./index-CgfCCdr4.js";import{r as _,R as K,m as Se}from"./icons-DCxkC3Ow.js";import{P as R}from"./Panel-D9-D5yaB.js";import{C as _e}from"./CopyableId-HrCqZqFc.js";import"./vendor-DxYwK_Rn.js";const $=({children:n,style:i={}})=>e.jsx("div",{style:{background:t.cardSurface,border:`1px solid ${t.borderGlass}`,padding:"24px",...i},children:n}),T=({children:n,onClick:i,variant:c="primary",disabled:r=!1,style:s={}})=>e.jsx("button",{onClick:i,disabled:r,style:{padding:"10px 20px",border:"none",cursor:r?"not-allowed":"pointer",fontFamily:t.mono,fontSize:"12px",letterSpacing:"1px",textTransform:"uppercase",transition:"all 0.2s",opacity:r?.5:1,...c==="primary"?{background:"transparent",color:t.purpleBright}:c==="danger"?{background:t.accentRed,color:"#fff"}:{background:t.cardSurface,border:`1px solid ${t.borderGlass}`,color:t.textSecondary},...s},children:n}),f=({label:n,value:i,onChange:c,type:r="text",placeholder:s="",style:d={}})=>e.jsxs("div",{style:{marginBottom:"12px",...d},children:[n&&e.jsx("label",{style:{display:"block",fontSize:"11px",letterSpacing:"1px",textTransform:"uppercase",color:t.textTertiary,marginBottom:"6px",fontFamily:t.mono},children:n}),e.jsx("input",{type:r,value:i,onChange:h=>c(r==="number"?parseFloat(h.target.value)||0:h.target.value),placeholder:s,style:{width:"100%",padding:"10px 12px",background:t.cardSurface,border:`1px solid ${t.borderGlass}`,color:t.textPrimary,fontSize:"14px",fontFamily:t.mono}})]}),J=({label:n,value:i,onChange:c,options:r,style:s={}})=>e.jsxs("div",{style:{marginBottom:"12px",...s},children:[n&&e.jsx("label",{style:{display:"block",fontSize:"11px",letterSpacing:"1px",textTransform:"uppercase",color:t.textTertiary,marginBottom:"6px",fontFamily:t.mono},children:n}),e.jsx("select",{value:i,onChange:d=>c(d.target.value),style:{width:"100%",padding:"10px 12px",background:t.cardSurface,border:`1px solid ${t.borderGlass}`,color:t.textPrimary,fontSize:"14px",fontFamily:t.mono},children:r.map(d=>e.jsx("option",{value:d.value,children:d.label},d.value))})]}),we=({boundary:n,onChange:i,onRemove:c})=>e.jsxs($,{style:{marginBottom:"12px",padding:"16px"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"12px"},children:[e.jsx("span",{style:{color:t.purpleBright,fontSize:"12px",fontFamily:t.mono},children:"NUMERIC BOUNDARY"}),e.jsx(T,{variant:"danger",onClick:c,style:{padding:"4px 12px",fontSize:"10px"},children:"Remove"})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"12px"},children:[e.jsx(f,{label:"Name",value:n.name||"",onChange:r=>i({...n,name:r}),placeholder:"e.g., Speed Limit"}),e.jsx(f,{label:"Parameter",value:n.parameter||"",onChange:r=>i({...n,parameter:r}),placeholder:"e.g., speed"}),e.jsx(f,{label:"Min Value",type:"number",value:n.min_value??"",onChange:r=>i({...n,min_value:r||null}),placeholder:"Optional"}),e.jsx(f,{label:"Max Value",type:"number",value:n.max_value??"",onChange:r=>i({...n,max_value:r||null}),placeholder:"Required"}),e.jsx(f,{label:"Unit",value:n.unit||"",onChange:r=>i({...n,unit:r}),placeholder:"e.g., km/h, °C"}),e.jsx(f,{label:"Tolerance",type:"number",value:n.tolerance||0,onChange:r=>i({...n,tolerance:r}),placeholder:"0"})]}),e.jsx(J,{label:"On Violation",value:n.violation_action||"block",onChange:r=>i({...n,violation_action:r}),options:[{value:"block",label:"Block Action"},{value:"warn",label:"Warn Only"},{value:"log",label:"Log Only"}],style:{marginTop:"12px",marginBottom:0}})]}),Ce=({boundary:n,onChange:i,onRemove:c})=>{var r,s;return e.jsxs($,{style:{marginBottom:"12px",padding:"16px"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"12px"},children:[e.jsx("span",{style:{color:t.accentGreen,fontSize:"12px",fontFamily:t.mono},children:"GEOGRAPHIC BOUNDARY"}),e.jsx(T,{variant:"danger",onClick:c,style:{padding:"4px 12px",fontSize:"10px"},children:"Remove"})]}),e.jsx(f,{label:"Name",value:n.name||"",onChange:d=>i({...n,name:d}),placeholder:"e.g., Warehouse Zone"}),e.jsx(J,{label:"Boundary Type",value:n.boundary_type||"circle",onChange:d=>i({...n,boundary_type:d}),options:[{value:"circle",label:"Circle (Center + Radius)"},{value:"polygon",label:"Polygon (Multiple Points)"}]}),n.boundary_type==="circle"||!n.boundary_type?e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"12px"},children:[e.jsx(f,{label:"Center Latitude",type:"number",value:((r=n.center)==null?void 0:r.lat)??"",onChange:d=>i({...n,center:{...n.center,lat:d}}),placeholder:"30.2672"}),e.jsx(f,{label:"Center Longitude",type:"number",value:((s=n.center)==null?void 0:s.lon)??"",onChange:d=>i({...n,center:{...n.center,lon:d}}),placeholder:"-97.7431"}),e.jsx(f,{label:"Radius (meters)",type:"number",value:n.radius_meters||"",onChange:d=>i({...n,radius_meters:d}),placeholder:"1000"})]}):e.jsx("div",{style:{color:t.textSecondary,fontSize:"12px",padding:"12px",background:"transparent"},children:"Polygon editor coming soon. For now, enter coordinates as JSON in the raw editor below."})]})},Be=({boundary:n,onChange:i,onRemove:c})=>e.jsxs($,{style:{marginBottom:"12px",padding:"16px"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"12px"},children:[e.jsx("span",{style:{color:t.accentAmber,fontSize:"12px",fontFamily:t.mono},children:"TIME BOUNDARY"}),e.jsx(T,{variant:"danger",onClick:c,style:{padding:"4px 12px",fontSize:"10px"},children:"Remove"})]}),e.jsx(f,{label:"Name",value:n.name||"",onChange:r=>i({...n,name:r}),placeholder:"e.g., Operating Hours"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"12px"},children:[e.jsx(f,{label:"Start Hour (0-23)",type:"number",value:n.allowed_hours_start??0,onChange:r=>i({...n,allowed_hours_start:Math.min(23,Math.max(0,r))})}),e.jsx(f,{label:"End Hour (0-23)",type:"number",value:n.allowed_hours_end??23,onChange:r=>i({...n,allowed_hours_end:Math.min(23,Math.max(0,r))})})]}),e.jsxs("div",{style:{marginTop:"12px"},children:[e.jsx("label",{style:{display:"block",fontSize:"11px",letterSpacing:"1px",textTransform:"uppercase",color:t.textTertiary,marginBottom:"8px",fontFamily:t.mono},children:"Allowed Days"}),e.jsx("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap"},children:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].map((r,s)=>{const d=n.allowed_days||[0,1,2,3,4,5,6],h=d.includes(s);return e.jsx("button",{onClick:()=>{const B=h?d.filter(j=>j!==s):[...d,s].sort();i({...n,allowed_days:B})},style:{padding:"6px 12px",border:`1px solid ${h?t.purpleBright:t.borderGlass}`,background:h?t.purpleBright:"transparent",color:h?"white":t.textSecondary,cursor:"pointer",fontSize:"12px",fontFamily:t.mono},children:r},r)})})]})]}),Te=({boundary:n,onChange:i,onRemove:c})=>e.jsxs($,{style:{marginBottom:"12px",padding:"16px"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"12px"},children:[e.jsx("span",{style:{color:t.purpleBright,fontSize:"12px",fontFamily:t.mono},children:"STATE BOUNDARY"}),e.jsx(T,{variant:"danger",onClick:c,style:{padding:"4px 12px",fontSize:"10px"},children:"Remove"})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"12px"},children:[e.jsx(f,{label:"Name",value:n.name||"",onChange:r=>i({...n,name:r}),placeholder:"e.g., Operation Mode"}),e.jsx(f,{label:"Parameter",value:n.parameter||"",onChange:r=>i({...n,parameter:r}),placeholder:"e.g., mode"})]}),e.jsx(f,{label:"Allowed Values (comma-separated)",value:(n.allowed_values||[]).join(", "),onChange:r=>i({...n,allowed_values:r.split(",").map(s=>s.trim()).filter(Boolean)}),placeholder:"e.g., idle, moving, charging"}),e.jsx(f,{label:"Forbidden Values (comma-separated)",value:(n.forbidden_values||[]).join(", "),onChange:r=>i({...n,forbidden_values:r.split(",").map(s=>s.trim()).filter(Boolean)}),placeholder:"e.g., emergency, override",style:{marginBottom:0}})]});function ke({applicationId:n,initialBoundaries:i,onSave:c,api:r}){var N;const[s,d]=_.useState({numeric_boundaries:[],geo_boundaries:[],time_boundaries:[],state_boundaries:[],safe_state:{action:"stop",notify:!0,log:!0},fail_closed:!0,telemetry_interval:1,heartbeat_interval:60}),[h,B]=_.useState(!1),[j,C]=_.useState(!1),[w,P]=_.useState("");_.useEffect(()=>{i&&typeof i=="object"&&d(p=>({...p,...i}))},[i]),_.useEffect(()=>{P(JSON.stringify(s,null,2))},[s]);const F=p=>{const a=`${p}_boundaries`,b={numeric:{type:"numeric",name:"",parameter:"",max_value:null,unit:"",tolerance:0,violation_action:"block"},geo:{type:"geo",name:"",boundary_type:"circle",center:{lat:0,lon:0},radius_meters:1e3,violation_action:"block"},time:{type:"time",name:"",allowed_hours_start:6,allowed_hours_end:22,allowed_days:[0,1,2,3,4],violation_action:"block"},state:{type:"state",name:"",parameter:"",allowed_values:[],forbidden_values:[],violation_action:"block"}};d(k=>({...k,[a]:[...k[a],b[p]]}))},u=(p,a,b)=>{const k=`${p}_boundaries`;d(O=>({...O,[k]:O[k].map((A,W)=>W===a?b:A)}))},g=(p,a)=>{const b=`${p}_boundaries`;d(k=>({...k,[b]:k[b].filter((O,A)=>A!==a)}))},x=async()=>{B(!0);try{await c(s)}finally{B(!1)}},y=()=>{try{const p=JSON.parse(w);d(p),C(!1)}catch(p){alert("Invalid JSON: "+p.message)}},G=s.numeric_boundaries.length+s.geo_boundaries.length+s.time_boundaries.length+s.state_boundaries.length;return e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"24px"},children:[e.jsxs("div",{children:[e.jsx("h2",{style:{fontFamily:t.mono,fontSize:"11px",letterSpacing:"2px",textTransform:"uppercase",color:t.purpleBright,margin:0},children:"Boundary Configuration"}),e.jsxs("p",{style:{color:t.textSecondary,margin:"8px 0 0",fontSize:"14px"},children:[G," boundaries defined"]})]}),e.jsxs("div",{style:{display:"flex",gap:"12px"},children:[e.jsx(T,{variant:"secondary",onClick:()=>C(!j),children:j?"Visual Editor":"Raw JSON"}),e.jsx(T,{onClick:x,disabled:h,children:h?"Saving...":"Save Boundaries"})]})]}),j?e.jsxs($,{children:[e.jsx("textarea",{value:w,onChange:p=>P(p.target.value),style:{width:"100%",minHeight:"400px",padding:"16px",background:t.cardSurface,border:`1px solid ${t.borderGlass}`,color:t.textPrimary,fontSize:"13px",fontFamily:t.mono,resize:"vertical"}}),e.jsx(T,{onClick:y,style:{marginTop:"12px"},children:"Apply JSON"})]}):e.jsxs("div",{children:[e.jsxs($,{style:{marginBottom:"24px"},children:[e.jsx("p",{style:{fontSize:"11px",letterSpacing:"1px",textTransform:"uppercase",color:t.textTertiary,margin:"0 0 12px",fontFamily:t.mono},children:"Add Boundary"}),e.jsxs("div",{style:{display:"flex",gap:"12px",flexWrap:"wrap"},children:[e.jsx(T,{variant:"secondary",onClick:()=>F("numeric"),children:"+ Numeric (Speed, Temp, etc.)"}),e.jsx(T,{variant:"secondary",onClick:()=>F("geo"),children:"+ Geographic (Geofence)"}),e.jsx(T,{variant:"secondary",onClick:()=>F("time"),children:"+ Time (Operating Hours)"}),e.jsx(T,{variant:"secondary",onClick:()=>F("state"),children:"+ State (Allowed Modes)"})]})]}),s.numeric_boundaries.length>0&&e.jsxs("div",{style:{marginBottom:"24px"},children:[e.jsxs("h3",{style:{color:t.textPrimary,fontSize:"14px",marginBottom:"12px"},children:["Numeric Boundaries (",s.numeric_boundaries.length,")"]}),s.numeric_boundaries.map((p,a)=>e.jsx(we,{boundary:p,onChange:b=>u("numeric",a,b),onRemove:()=>g("numeric",a)},a))]}),s.geo_boundaries.length>0&&e.jsxs("div",{style:{marginBottom:"24px"},children:[e.jsxs("h3",{style:{color:t.textPrimary,fontSize:"14px",marginBottom:"12px"},children:["Geographic Boundaries (",s.geo_boundaries.length,")"]}),s.geo_boundaries.map((p,a)=>e.jsx(Ce,{boundary:p,onChange:b=>u("geo",a,b),onRemove:()=>g("geo",a)},a))]}),s.time_boundaries.length>0&&e.jsxs("div",{style:{marginBottom:"24px"},children:[e.jsxs("h3",{style:{color:t.textPrimary,fontSize:"14px",marginBottom:"12px"},children:["Time Boundaries (",s.time_boundaries.length,")"]}),s.time_boundaries.map((p,a)=>e.jsx(Be,{boundary:p,onChange:b=>u("time",a,b),onRemove:()=>g("time",a)},a))]}),s.state_boundaries.length>0&&e.jsxs("div",{style:{marginBottom:"24px"},children:[e.jsxs("h3",{style:{color:t.textPrimary,fontSize:"14px",marginBottom:"12px"},children:["State Boundaries (",s.state_boundaries.length,")"]}),s.state_boundaries.map((p,a)=>e.jsx(Te,{boundary:p,onChange:b=>u("state",a,b),onRemove:()=>g("state",a)},a))]}),e.jsxs($,{children:[e.jsx("h3",{style:{fontSize:"11px",letterSpacing:"1px",textTransform:"uppercase",color:t.textTertiary,margin:"0 0 16px",fontFamily:t.mono},children:"Enforcement Settings"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"16px"},children:[e.jsx(J,{label:"On Violation",value:((N=s.safe_state)==null?void 0:N.action)||"stop",onChange:p=>d(a=>({...a,safe_state:{...a.safe_state,action:p}})),options:[{value:"stop",label:"Stop System"},{value:"reduce",label:"Reduce Operation"},{value:"handoff",label:"Human Handoff"}]}),e.jsx(J,{label:"Fail Mode",value:s.fail_closed?"closed":"open",onChange:p=>d(a=>({...a,fail_closed:p==="closed"})),options:[{value:"closed",label:"Fail Closed (Block)"},{value:"open",label:"Fail Open (Allow)"}]}),e.jsx(f,{label:"Telemetry Interval (sec)",type:"number",value:s.telemetry_interval||1,onChange:p=>d(a=>({...a,telemetry_interval:p}))})]})]}),G===0&&e.jsxs($,{style:{textAlign:"center",padding:"48px"},children:[e.jsx("p",{style:{color:t.textSecondary,fontSize:"16px",margin:0},children:"No boundaries defined yet."}),e.jsx("p",{style:{color:t.textTertiary,fontSize:"14px",marginTop:"8px"},children:"Add boundaries above to define the system's Operational Design Domain."})]})]})]})}function D(n){return n?new Date(n).toISOString().replace("T"," ").substring(0,19)+"Z":null}function ze(n,i){const c=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),r=URL.createObjectURL(c),s=document.createElement("a");s.href=r,s.download=i,s.click(),URL.revokeObjectURL(r)}function ie(n,i,c){const r=[i.join(","),...n.map(B=>i.map(j=>{const C=String(B[j]??"").replace(/"/g,'""');return C.includes(",")||C.includes('"')||C.includes(`
`)?'"'+C+'"':C}).join(","))].join(`
`),s=new Blob([r],{type:"text/csv;charset=utf-8;"}),d=URL.createObjectURL(s),h=document.createElement("a");h.href=d,h.download=c,h.click(),URL.revokeObjectURL(d)}const U=n=>({display:"flex",alignItems:"center",gap:"6px",padding:"7px 14px",background:t.cardSurface,border:"1px solid "+t.borderGlass,color:n||t.purpleBright,fontFamily:t.mono,fontSize:"10px",fontWeight:600,letterSpacing:"0.08em",textTransform:"uppercase",cursor:"pointer",whiteSpace:"nowrap",textDecoration:"none"});function Fe({app:n,history:i=[],comments:c=[],isAdmin:r=!1}){const[s,d]=_.useState({}),[h,B]=K.useState([]);K.useEffect(()=>{v.get("/api/certificates/").then(u=>{const g=u.data??[];B(g.filter(x=>x.application_id===n.id||x.system_name===n.system_name))}).catch(()=>{})},[n.id]);const j=(u,g)=>d(x=>({...x,[u]:g})),C=h.find(u=>["conformant","active","issued"].includes(u.state)),w=async()=>{j("json",!0);try{let u=[];try{u=(await v.get("/api/audit/logs?resource_type=application&resource_id="+n.id+"&limit=500&offset=0")).data.logs??[]}catch{}const g={_meta:{export_type:"ODDC Conformance Application Bundle",standard:"ODDC v1.0",issuer:"Sentinel Authority",exported_at:new Date().toISOString(),exported_by:r?"admin":"applicant"},application:{...n,submitted_at:D(n.submitted_at),updated_at:D(n.updated_at)},state_history:i.map(x=>({...x,timestamp:D(x.timestamp)})),certificates:h.map(x=>({...x,issued_at:D(x.issued_at),expires_at:D(x.expires_at)})),comments:(r?c:c.filter(x=>!x.is_internal)).map(x=>({...x,created_at:D(x.created_at)})),audit_logs:u.map(x=>({...x,timestamp:D(x.timestamp)}))};ze(g,"ODDC-Bundle-"+n.application_number+"-"+new Date().toISOString().split("T")[0]+".json")}catch(u){console.error("Export failed",u)}j("json",!1)},P=()=>{if(!i.length)return;const u=i.map(g=>{var x,y;return{timestamp:D(g.timestamp)??"",action:g.action??"",user_email:g.user_email??"",old_state:((x=g.details)==null?void 0:x.old_state)??"",new_state:((y=g.details)==null?void 0:y.new_state)??""}});ie(u,["timestamp","action","user_email","old_state","new_state"],"StateHistory-"+n.application_number+".csv")},F=async()=>{j("audit",!0);try{const g=(await v.get("/api/audit/logs?resource_type=application&resource_id="+n.id+"&limit=500&offset=0")).data.logs??[];if(!g.length){j("audit",!1);return}const x=g.map(y=>({timestamp:D(y.timestamp)??"",user_email:y.user_email??"",action:y.action??"",resource_type:y.resource_type??"",resource_id:y.resource_id??"",details:y.details?JSON.stringify(y.details):"",log_hash:y.log_hash??""}));ie(x,["timestamp","user_email","action","resource_type","resource_id","details","log_hash"],"AuditLog-"+n.application_number+".csv")}catch(u){console.error("Audit export failed",u)}j("audit",!1)};return e.jsxs("div",{style:{border:"1px solid "+t.borderGlass,padding:"20px",borderRadius:8},children:[e.jsxs("div",{style:{marginBottom:"16px"},children:[e.jsx("div",{style:{fontFamily:t.mono,fontSize:"10px",fontWeight:600,letterSpacing:"0.12em",textTransform:"uppercase",color:t.textTertiary,marginBottom:"4px"},children:"Export & Records"}),e.jsxs("div",{style:{fontSize:"12px",color:t.textDim},children:[n.application_number," · ",new Date().toISOString().split("T")[0]]})]}),e.jsxs("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap"},children:[e.jsx("button",{onClick:w,disabled:s.json,style:U(t.purpleBright),children:s.json?"↻ Building…":"↓ Full Bundle (JSON)"}),i.length>0&&e.jsx("button",{onClick:P,style:U(t.textSecondary),children:"↓ State History (CSV)"}),r&&e.jsx("button",{onClick:F,disabled:s.audit,style:U(t.textSecondary),children:s.audit?"↻ Fetching…":"↓ Audit Log (CSV)"}),C&&e.jsx("a",{href:ge+"/api/certificates/"+C.certificate_number+"/pdf",target:"_blank",rel:"noreferrer noopener",style:U(t.accentGreen),children:"↓ Certificate PDF"})]}),e.jsxs("div",{style:{marginTop:"12px",fontFamily:t.mono,fontSize:"10px",color:t.textDim,lineHeight:1.6},children:["JSON bundle: application record · state history · certificates · ",r?"all comments":"public comments"," · audit log"]})]})}function M(n){return n?new Date(n).toISOString().replace("T"," ").substring(0,19)+"Z":"—"}function oe(n){return n==="conformant"?t.accentGreen:n==="revoked"||n==="suspended"?t.accentRed:n==="testing"||n==="approved"?t.purpleBright:t.accentAmber}const I={fontFamily:t.mono,fontSize:"11px",fontWeight:600,letterSpacing:"0.10em",textTransform:"uppercase",color:t.textTertiary,marginBottom:"16px"},z=(n,i=!1)=>({padding:"8px 16px",background:i?n:"transparent",border:`1px solid ${i?n:t.borderGlass}`,color:i?"#fff":n,fontFamily:t.mono,fontSize:"11px",fontWeight:600,letterSpacing:"0.08em",textTransform:"uppercase",cursor:"pointer"}),re=[{key:"pending",label:"Submitted",icon:"1"},{key:"under_review",label:"Under Review",icon:"2"},{key:"approved",label:"Approved",icon:"3"},{key:"testing",label:"CAT-72 Testing",icon:"4"},{key:"conformant",label:"Conformant",icon:"✓"}],Ae={pending:"Your application is queued for review by the Sentinel Authority team.",under_review:"Our team is evaluating your ODD specification and boundary definitions.",approved:"Your system is approved. The ENVELO agent is being configured for CAT-72 testing.",testing:"CAT-72 continuous conformance test is in progress (72-hour minimum).",conformant:"Your system has achieved ODDC Conformance. Your certificate and ENVELO agent credentials are active.",revoked:"This application has been suspended. Contact info@sentinelauthority.org for remediation steps.",suspended:"This application has been suspended. Contact info@sentinelauthority.org for remediation steps."};function Re({preview:n,onCancel:i,onConfirm:c}){return n?e.jsx("div",{style:{position:"fixed",inset:0,zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,0.4)",backdropFilter:"blur(6px)"},children:e.jsxs("div",{style:{background:"rgba(255,255,255,0.97)",border:`1px solid ${t.borderGlass}`,maxWidth:"min(650px, 95vw)",width:"95%",maxHeight:"80vh",overflow:"hidden",display:"flex",flexDirection:"column"},children:[e.jsxs("div",{style:{padding:"20px 24px",borderBottom:`1px solid ${t.borderGlass}`,display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:"12px"},children:[e.jsxs("div",{children:[e.jsx("h3",{style:{margin:0,fontFamily:t.mono,fontSize:"11px",fontWeight:600,letterSpacing:"0.10em",textTransform:"uppercase",color:t.purpleBright},children:"Email Preview"}),e.jsxs("p",{style:{margin:"4px 0 0",fontSize:"12px",color:t.textTertiary},children:["Will be sent to ",e.jsx("strong",{style:{color:t.textPrimary},children:n.to})]})]}),e.jsx("button",{onClick:i,style:{background:"none",border:"none",color:t.textTertiary,cursor:"pointer",fontSize:"18px",padding:"4px 8px"},children:"×"})]}),e.jsxs("div",{style:{padding:"14px 24px",borderBottom:`1px solid ${t.borderGlass}`},children:[e.jsx("div",{style:{fontSize:"11px",color:t.textTertiary,marginBottom:"2px",fontFamily:t.mono},children:"Subject"}),e.jsx("div",{style:{fontSize:"14px",color:t.textPrimary,fontWeight:500},children:n.subject})]}),e.jsx("div",{style:{flex:1,overflow:"auto",padding:"20px 24px"},children:e.jsx("div",{dangerouslySetInnerHTML:{__html:n.html}})}),e.jsxs("div",{style:{padding:"16px 24px",borderTop:`1px solid ${t.borderGlass}`,display:"flex",justifyContent:"flex-end",gap:"10px"},children:[e.jsx("button",{onClick:i,style:z(t.textSecondary),children:"Cancel"}),e.jsxs("button",{onClick:c,style:z(n.newState==="suspended"?t.accentRed:"#fff",n.newState!=="suspended"),children:[n.label," + Send Email"]})]})]})}):null}function Ge(){var Z;const{id:n}=he(),i=ye(),{user:c}=fe(),r=je(),s=be(),d=ve(),[h,B]=_.useState(!1),[j,C]=_.useState(null),[w,P]=_.useState(""),[F,u]=_.useState(!1),[g,x]=_.useState(!1),[y,G]=_.useState(null),[N,p]=_.useState(!1),{data:a,isLoading:b,isError:k}=q({queryKey:["application",n],queryFn:()=>v.get(`/api/applications/${n}`).then(o=>o.data),enabled:!!n}),{data:O=[]}=q({queryKey:["application",n,"history"],queryFn:()=>v.get(`/api/applications/${n}/history`).then(o=>o.data),enabled:!!n}),{data:A=[],refetch:W}=q({queryKey:["application",n,"comments"],queryFn:()=>v.get(`/api/applications/${n}/comments`).then(o=>o.data),enabled:!!n}),L=()=>{d.invalidateQueries({queryKey:["application",n]}),d.invalidateQueries({queryKey:["applications"]})},V=async(o,m)=>{p(!0);try{const l=await v.get(`/api/applications/${n}/email-preview?new_state=${o}`);G({...l.data,label:m,newState:o})}catch{i.show("Preview failed","error")}p(!1)},se=async()=>{var o,m;if(y)try{await v.patch(`/api/applications/${n}/state?new_state=${y.newState}`),G(null),L(),i.show(`State changed to ${y.newState}`,"success")}catch(l){i.show("Failed: "+(((m=(o=l.response)==null?void 0:o.data)==null?void 0:m.detail)||l.message),"error")}},le=async o=>{var m,l;if(await r({title:"Change Status",message:`Change status to ${o.toUpperCase()}?`}))try{if(await v.patch(`/api/applications/${n}/state?new_state=${o}`),o==="approved")try{await v.post("/api/apikeys/admin/provision",null,{params:{application_id:n,send_email:!0}})}catch{}L()}catch(S){i.show("Failed: "+(((l=(m=S.response)==null?void 0:m.data)==null?void 0:l.detail)||S.message),"error")}},de=async()=>{var o,m;if(await r({title:"Schedule Test",message:"Schedule a CAT-72 test? It will need to be started manually."})){B(!0);try{const l=await v.post("/api/cat72/tests",{application_id:parseInt(n)});C(l.data),i.show(`CAT-72 Test created: ${l.data.test_id} — Go to CAT-72 Console to start.`,"success")}catch(l){i.show("Failed: "+(((m=(o=l.response)==null?void 0:o.data)==null?void 0:m.detail)||l.message),"error")}B(!1)}},ce=async()=>{var o,m;if(await r({title:"Delete Application",message:"Are you sure? This cannot be undone.",danger:!0,confirmLabel:"Delete"}))try{await v.delete(`/api/applications/${n}`),i.show("Application deleted","success"),s("/applications")}catch(l){i.show("Failed: "+(((m=(o=l.response)==null?void 0:o.data)==null?void 0:m.detail)||l.message),"error")}},Q=async()=>{var o,m;if(await r({title:"Reinstate",message:"Reinstate to pending? Applicant will go through review again."}))try{await v.patch(`/api/applications/${n}/state?new_state=pending`),L()}catch(l){i.show("Failed: "+(((m=(o=l.response)==null?void 0:o.data)==null?void 0:m.detail)||l.message),"error")}},pe=async()=>{var o,m;if(w.trim()){x(!0);try{await v.post(`/api/applications/${n}/comments`,{content:w,is_internal:F}),P(""),u(!1),W(),i.show("Comment added","success")}catch(l){i.show("Failed: "+(((m=(o=l.response)==null?void 0:o.data)==null?void 0:m.detail)||l.message),"error")}x(!1)}},xe=async o=>{var m,l;try{await v.delete(`/api/applications/${n}/comments/${o}`),W(),i.show("Comment deleted","success")}catch(S){i.show("Failed: "+(((l=(m=S.response)==null?void 0:m.data)==null?void 0:l.detail)||S.message),"error")}},me=_.useMemo(()=>re.findIndex(o=>o.key===(a==null?void 0:a.state)),[a==null?void 0:a.state]),ue=(a==null?void 0:a.state)==="revoked"||(a==null?void 0:a.state)==="suspended",E=(c==null?void 0:c.role)==="admin";return b?e.jsx("div",{style:{padding:"40px",textAlign:"center",fontFamily:t.mono,fontSize:"11px",color:t.textDim,letterSpacing:"0.10em"},children:"LOADING..."}):k||!a?e.jsxs("div",{style:{padding:"40px",textAlign:"center"},children:[e.jsx("p",{style:{fontFamily:t.mono,fontSize:"11px",color:t.accentRed,marginBottom:"16px"},children:"Failed to load application."}),e.jsx(Y,{to:"/applications",style:{color:t.purpleBright,fontFamily:t.mono,fontSize:"11px"},children:"← Back to Applications"})]}):e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"24px"},children:[e.jsx(Re,{preview:y,onCancel:()=>G(null),onConfirm:se}),e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:"12px"},children:[e.jsxs(Y,{to:"/applications",style:{display:"flex",alignItems:"center",gap:"6px",color:t.textTertiary,fontFamily:t.mono,fontSize:"11px",letterSpacing:"0.08em",textTransform:"uppercase",textDecoration:"none"},children:[e.jsx(Se,{size:13})," Back"]}),E&&e.jsxs("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap"},children:[a.state==="pending"&&e.jsx("button",{onClick:()=>V("under_review","Begin Review"),disabled:N,style:z(t.accentAmber),children:"Begin Review"}),(a.state==="pending"||a.state==="under_review")&&e.jsx("button",{onClick:()=>V("approved","Approve Application"),disabled:N,style:z(t.accentGreen),children:"Approve"}),a.state==="approved"&&e.jsx("button",{onClick:de,disabled:h,style:z("#fff",!0),children:h?"Scheduling…":"Schedule CAT-72"}),["pending","under_review","approved","testing","conformant"].includes(a.state)&&e.jsx("button",{onClick:()=>V("suspended","Suspend Application"),style:z(t.accentRed),children:"Suspend"}),(a.state==="suspended"||a.state==="revoked")&&e.jsx("button",{onClick:Q,style:z(t.accentGreen),children:"Reinstate"}),a.state==="expired"&&e.jsx("button",{onClick:Q,style:z(t.purpleBright),children:"Re-open"}),e.jsx("button",{onClick:ce,style:z(t.accentRed),children:"Delete"})]})]}),e.jsxs(R,{children:[e.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:"12px",marginBottom:"20px"},children:re.map((o,m)=>{const l=o.key===a.state,S=me>m,H=S?t.accentGreen:l?t.purpleBright:t.borderGlass;return e.jsxs(K.Fragment,{children:[m>0&&e.jsx("div",{style:{flex:1,height:"2px",background:S?t.accentGreen:t.borderGlass,margin:"0 8px",borderRadius:8}}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:"6px",minWidth:"72px"},children:[e.jsx("div",{style:{width:"30px",height:"30px",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",fontFamily:t.mono,fontSize:"11px",fontWeight:700,background:S?"rgba(22,135,62,0.08)":l?"rgba(29,26,59,0.12)":"transparent",border:`2px solid ${H}`,color:H},children:S?"✓":o.icon}),e.jsx("span",{style:{fontFamily:t.mono,fontSize:"9px",fontWeight:600,letterSpacing:"0.08em",textTransform:"uppercase",color:l?t.purpleBright:S?t.accentGreen:t.textDim,textAlign:"center"},children:o.label})]})]},o.key)})}),ue&&e.jsx("div",{style:{padding:"10px 14px",border:`1px solid ${t.accentRed}20`,marginBottom:"10px"},children:e.jsx("span",{style:{color:t.accentRed,fontFamily:t.mono,fontSize:"11px",fontWeight:600},children:"⚠ SUSPENDED — Pending review."})}),e.jsx("div",{style:{padding:"12px 16px",border:`1px solid ${t.borderGlass}`},children:e.jsx("span",{style:{color:t.textSecondary,fontSize:"13px",lineHeight:1.6},children:Ae[a.state]||""})})]}),j&&e.jsx("div",{style:{padding:"14px 16px",border:`1px solid ${t.accentGreen}30`,background:`${t.accentGreen}06`},children:e.jsxs("span",{style:{color:t.accentGreen,fontFamily:t.mono,fontSize:"12px",fontWeight:600},children:["Test Created: ",j.test_id," — ",e.jsx(Y,{to:"/cat72",style:{color:t.purpleBright},children:"Go to CAT-72 Console →"})]})}),e.jsxs("div",{children:[e.jsx("p",{style:{fontFamily:t.mono,fontSize:"10px",fontWeight:600,letterSpacing:"0.20em",textTransform:"uppercase",color:t.purpleBright,marginBottom:"8px",display:"flex",alignItems:"center",gap:"8px"},children:e.jsx(_e,{id:a.application_number,style:{color:t.purpleBright,fontSize:"10px"}})}),e.jsx("h1",{style:{fontFamily:t.serif,fontSize:"clamp(24px, 5vw, 36px)",fontWeight:200,margin:0},children:a.system_name}),a.system_description&&e.jsx("p",{style:{color:t.textSecondary,marginTop:"8px",marginBottom:0},children:a.system_description})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(280px, 1fr))",gap:"24px"},children:[e.jsxs(R,{children:[e.jsx("h2",{style:I,children:"Organization"}),e.jsx("p",{style:{color:t.textPrimary,fontSize:"17px",fontWeight:500,marginBottom:"12px"},children:a.organization_name}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"6px"},children:[e.jsxs("p",{style:{color:t.textSecondary,margin:0},children:[e.jsx("strong",{children:"Contact:"})," ",a.contact_name]}),e.jsxs("p",{style:{color:t.textSecondary,margin:0},children:[e.jsx("strong",{children:"Email:"})," ",a.contact_email]}),a.contact_phone&&e.jsxs("p",{style:{color:t.textSecondary,margin:0},children:[e.jsx("strong",{children:"Phone:"})," ",a.contact_phone]})]})]}),e.jsxs(R,{children:[e.jsx("h2",{style:I,children:"Status"}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px",marginBottom:"14px",flexWrap:"wrap"},children:[e.jsx("span",{style:{fontFamily:t.mono,fontSize:"11px",fontWeight:600,letterSpacing:"0.08em",textTransform:"uppercase",padding:"3px 10px",background:`${oe(a.state)}10`,color:oe(a.state)},children:a.state}),E&&e.jsxs("select",{value:a.state,onChange:o=>le(o.target.value),style:{background:t.cardSurface,border:`1px solid ${t.borderGlass}`,color:t.textPrimary,fontFamily:t.mono,fontSize:"11px",padding:"4px 8px",cursor:"pointer"},children:[e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"under_review",children:"Under Review"}),e.jsx("option",{value:"approved",children:"Approved"}),e.jsx("option",{value:"testing",children:"Testing"}),e.jsx("option",{value:"conformant",children:"Conformant"}),e.jsx("option",{value:"revoked",children:"Revoked"})]})]}),e.jsxs("p",{style:{color:t.textSecondary,margin:0,fontFamily:t.mono,fontSize:"12px"},children:["Submitted: ",M(a.submitted_at)]})]})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(280px, 1fr))",gap:"24px"},children:[e.jsxs(R,{children:[e.jsx("h2",{style:I,children:"System Details"}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"8px"},children:[e.jsxs("p",{style:{color:t.textSecondary,margin:0},children:[e.jsx("strong",{children:"Version:"})," ",a.system_version||"—"]}),e.jsxs("p",{style:{color:t.textSecondary,margin:0},children:[e.jsx("strong",{children:"Manufacturer:"})," ",a.manufacturer||"—"]}),a.facility_location&&e.jsxs("p",{style:{color:t.textSecondary,margin:0},children:[e.jsx("strong",{children:"Facility:"})," ",a.facility_location]}),a.preferred_test_date&&e.jsxs("p",{style:{color:t.textSecondary,margin:0},children:[e.jsx("strong",{children:"Preferred Test Date:"})," ",M(a.preferred_test_date).substring(0,10)]})]})]}),e.jsxs(R,{children:[e.jsx("h2",{style:I,children:"Safety Boundaries & Operational Limits"}),e.jsx("pre",{style:{color:t.textSecondary,lineHeight:1.7,whiteSpace:"pre-wrap",margin:0,fontSize:"12px",fontFamily:t.mono,wordBreak:"break-word"},children:typeof a.envelope_definition=="object"?JSON.stringify(a.envelope_definition,null,2):a.envelope_definition||"Not specified"})]})]}),e.jsxs(R,{children:[e.jsx("h2",{style:I,children:"ODD Specification"}),e.jsx("p",{style:{color:t.textSecondary,lineHeight:1.7,whiteSpace:"pre-wrap",margin:0},children:typeof a.odd_specification=="object"?((Z=a.odd_specification)==null?void 0:Z.description)||JSON.stringify(a.odd_specification,null,2):a.odd_specification})]}),E&&e.jsx(ke,{applicationId:a.id,initialBoundaries:a.envelope_definition||{},onSave:async o=>{try{await v.patch(`/api/applicants/${a.id}`,{envelope_definition:o}),i.show("Boundaries saved","success"),L()}catch(m){i.show("Failed to save: "+m.message,"error")}}}),O.length>0&&e.jsxs(R,{children:[e.jsx("h2",{style:I,children:"State Change History"}),e.jsxs("div",{style:{position:"relative",paddingLeft:"28px"},children:[e.jsx("div",{style:{position:"absolute",left:"8px",top:"4px",bottom:"4px",width:"1px",background:t.borderGlass,borderRadius:8}}),O.map((o,m)=>{var ee,te,ne,ae;const l=(ee=o.details)==null?void 0:ee.new_state,S=l==="conformant"||l==="approved"?t.accentGreen:l==="suspended"||l==="revoked"?t.accentRed:l==="under_review"||l==="testing"?t.purpleBright:o.action==="submitted"?t.purpleBright:t.accentAmber,H=(l==null?void 0:l.replace("_"," "))||((te=o.action)==null?void 0:te.replace("_"," ")),X=(ae=(ne=o.details)==null?void 0:ne.old_state)==null?void 0:ae.replace("_"," ");return e.jsxs("div",{style:{position:"relative",paddingBottom:m<O.length-1?"20px":0},children:[e.jsx("div",{style:{position:"absolute",left:"-24px",top:"3px",width:"11px",height:"11px",borderRadius:"50%",background:`${S}10`,border:`2px solid ${S}`}}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",flexWrap:"wrap",gap:"12px"},children:[e.jsxs("div",{children:[e.jsx("span",{style:{fontFamily:t.mono,fontSize:"11px",fontWeight:600,color:S,textTransform:"uppercase",letterSpacing:"0.06em"},children:H}),X&&o.action!=="submitted"&&e.jsxs("span",{style:{fontFamily:t.mono,fontSize:"10px",color:t.textTertiary,marginLeft:"8px"},children:["from ",X]}),e.jsx("div",{style:{marginTop:"3px",fontSize:"12px",color:t.textTertiary},children:o.user_email})]}),e.jsx("div",{style:{textAlign:"right",fontFamily:t.mono,fontSize:"10px",color:t.textTertiary,flexShrink:0},children:M(o.timestamp)})]})]},m)})]})]}),e.jsxs(R,{children:[e.jsx("h2",{style:I,children:"Comments & Notes"}),e.jsxs("div",{style:{marginBottom:A.length>0?"20px":0},children:[e.jsx("textarea",{value:w,onChange:o=>P(o.target.value),rows:3,placeholder:"Add a comment or note...",style:{width:"100%",background:t.cardSurface,border:`1px solid ${t.borderGlass}`,color:t.textPrimary,fontSize:"13px",fontFamily:"inherit",padding:"12px 16px",outline:"none",resize:"vertical",boxSizing:"border-box",transition:"border-color 0.2s"},onFocus:o=>o.target.style.borderColor=t.purpleBright,onBlur:o=>o.target.style.borderColor=t.borderGlass}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:"12px",marginTop:"8px"},children:[E&&e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"6px",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:F,onChange:o=>u(o.target.checked),style:{accentColor:t.purpleBright}}),e.jsx("span",{style:{fontFamily:t.mono,fontSize:"10px",fontWeight:600,color:t.textTertiary,letterSpacing:"0.08em",textTransform:"uppercase"},children:"Internal only"})]}),e.jsx("button",{onClick:pe,disabled:g||!w.trim(),style:{...z("#fff",!0),background:w.trim()?t.purplePrimary:"transparent",borderColor:w.trim()?t.purpleBright:t.borderGlass,color:w.trim()?"#fff":t.textTertiary,opacity:g?.6:1,cursor:w.trim()?"pointer":"default",borderRadius:8},children:g?"Posting…":"Post Comment"})]})]}),A.length>0&&e.jsx("div",{style:{borderTop:`1px solid ${t.borderGlass}`,paddingTop:"16px"},children:A.map(o=>e.jsxs("div",{style:{padding:"12px 0",borderBottom:`1px solid ${t.borderSubtle}`},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",flexWrap:"wrap",gap:"12px",marginBottom:"6px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("span",{style:{fontFamily:t.mono,fontSize:"12px",fontWeight:600,color:o.user_role==="admin"?t.purpleBright:t.textSecondary},children:o.user_email}),o.user_role==="admin"&&e.jsx("span",{style:{fontFamily:t.mono,fontSize:"9px",fontWeight:600,padding:"1px 6px",color:t.purpleBright,border:`1px solid ${t.purpleBright}30`,textTransform:"uppercase"},children:"Admin"}),o.is_internal&&e.jsx("span",{style:{fontFamily:t.mono,fontSize:"9px",fontWeight:600,padding:"1px 6px",color:t.accentAmber,border:`1px solid ${t.accentAmber}30`,textTransform:"uppercase"},children:"Internal"})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px"},children:[e.jsx("span",{style:{fontFamily:t.mono,fontSize:"10px",color:t.textDim},children:M(o.created_at)}),(E||(c==null?void 0:c.email)===o.user_email)&&e.jsx("button",{onClick:()=>xe(o.id),style:{background:"none",border:"none",color:t.textTertiary,cursor:"pointer",fontSize:"14px",padding:0,opacity:.5},title:"Delete",children:"×"})]})]}),e.jsx("p",{style:{color:t.textSecondary,fontSize:"13px",lineHeight:1.6,margin:0,whiteSpace:"pre-wrap"},children:o.content})]},o.id))}),A.length===0&&!w&&e.jsx("p",{style:{color:t.textDim,fontSize:"13px",margin:0,fontFamily:t.mono},children:"No comments yet"})]}),e.jsx(Fe,{app:a,history:O,comments:A,isAdmin:E}),a.notes&&e.jsxs(R,{children:[e.jsx("h2",{style:I,children:"Applicant Notes"}),e.jsx("p",{style:{color:t.textSecondary,lineHeight:1.7,whiteSpace:"pre-wrap",margin:0},children:a.notes})]})]})}export{Ge as default};
