import{b as Y,j as r,s,d as m}from"./index-BedPMBGb.js";import{r as o}from"./icons-BDb2Zpiz.js";import{u as $}from"./useQuery-QkvP9CZV.js";import{P as z}from"./Panel-BxJjkWUN.js";import{S as ee}from"./SectionHeader-Brkl_dpu.js";import{D as te,B as se}from"./Badge-C_V72iBU.js";import"./vendor-BY35fGmp.js";function re(t){return t?new Date(t).toISOString().replace("T"," ").substring(0,19)+"Z":"—"}function ie(t){return t?t.includes("issued")||t.includes("approved")||t.includes("conformant")?"green":t.includes("suspended")||t.includes("revoked")||t.includes("failed")?"red":t.includes("pending")||t.includes("under_review")?"amber":"purple":"dim"}function A({actionFilter:t,resourceFilter:a,emailFilter:p,dateFrom:d,dateTo:h,page:u,limit:S}){const i=new URLSearchParams;return t&&i.set("action",t),a&&i.set("resource_type",a),p&&i.set("user_email",p),d&&i.set("date_from",new Date(d).toISOString()),h&&i.set("date_to",new Date(h+"T23:59:59").toISOString()),i.set("limit",S),i.set("offset",u*S),i.toString()}const L=50,f={background:s.cardSurface,border:`1px solid ${s.borderGlass}`,padding:"7px 12px",color:s.textPrimary,fontSize:"12px",fontFamily:s.mono,outline:"none"},ae=[{key:"timestamp",label:"Timestamp (UTC)",style:{whiteSpace:"nowrap",fontFamily:s.mono,fontSize:"11px",color:s.textSecondary},render:t=>re(t.timestamp)},{key:"user_email",label:"User",render:t=>t.user_email||"—"},{key:"action",label:"Action",render:t=>r.jsx(se,{variant:ie(t.action),children:t.action})},{key:"resource",label:"Resource",style:{fontFamily:s.mono,fontSize:"11px",color:s.textTertiary},render:t=>t.resource_type?`${t.resource_type}${t.resource_id?` #${t.resource_id}`:""}`:"—"},{key:"details",label:"Details",style:{maxWidth:"280px",fontSize:"12px"},render:t=>t.details?Object.entries(t.details).filter(([a])=>a!=="old_state").map(([a,p])=>r.jsxs("span",{style:{marginRight:"10px"},children:[r.jsxs("span",{style:{color:s.textTertiary},children:[a.replace(/_/g," "),":"]})," ",r.jsx("span",{style:{color:s.textSecondary},children:String(p)})]},a)):"—"},{key:"log_hash",label:"Hash",style:{fontFamily:s.mono,fontSize:"10px",color:s.textDim,letterSpacing:"0.04em",maxWidth:"120px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},render:t=>t.log_hash?t.log_hash.substring(0,16)+"…":"—"}];function xe(){const t=Y(),[a,p]=o.useState(""),[d,h]=o.useState(""),[u,S]=o.useState(""),[i,l]=o.useState(0),[b,j]=o.useState(""),[v,w]=o.useState(""),[k,T]=o.useState("30"),[n,O]=o.useState(null),[_,C]=o.useState(!1),{data:U}=$({queryKey:["audit-actions"],queryFn:()=>m.get("/api/audit/actions").then(e=>e.data.actions||[]),staleTime:1/0}),{data:E}=$({queryKey:["audit-resources"],queryFn:()=>m.get("/api/audit/resource-types").then(e=>e.data.resource_types||[]),staleTime:1/0}),V=U??[],q=E??[],W=["audit-logs",a,d,u,b,v,i],{data:g,isLoading:I,isFetching:B}=$({queryKey:W,queryFn:()=>{const e=A({actionFilter:a,resourceFilter:d,emailFilter:u,dateFrom:b,dateTo:v,page:i,limit:L});return m.get(`/api/audit/logs?${e}`).then(y=>y.data)},keepPreviousData:!0}),G=(g==null?void 0:g.logs)??[],R=(g==null?void 0:g.total)??0,x=Math.ceil(R/L),M=o.useCallback(e=>{if(T(e),l(0),e==="all")j(""),w("");else{const y=new Date;y.setDate(y.getDate()-parseInt(e)),j(y.toISOString().split("T")[0]),w("")}},[]),N=async()=>{try{const e=A({actionFilter:a,resourceFilter:d,emailFilter:u,dateFrom:b,dateTo:v,page:0,limit:1e4}),D=(await m.get(`/api/audit/logs?${e}`)).data.logs||[];if(!D.length){t.show("No entries to export","warning");return}const K=["Timestamp,User,Action,Resource Type,Resource ID,Details,Hash",...D.map(c=>{const Z=c.details?Object.entries(c.details).map(([J,X])=>`${J}=${X}`).join("; "):"";return[c.timestamp||"",c.user_email||"",c.action||"",c.resource_type||"",c.resource_id||"",`"${Z.replace(/"/g,'""')}"`,c.log_hash||""].join(",")})].join(`
`),Q=new Blob([K],{type:"text/csv"}),P=URL.createObjectURL(Q),F=document.createElement("a");F.href=P,F.download=`audit-log-${new Date().toISOString().split("T")[0]}.csv`,F.click(),URL.revokeObjectURL(P),t.show(`CSV exported (${D.length} entries)`,"success")}catch{t.show("Export failed","error")}},H=async()=>{C(!0);try{const e=await m.get("/api/audit/verify?limit=5000");O(e.data),t.show(e.data.integrity==="passed"?`Integrity verified — ${e.data.valid} entries valid`:`Integrity check FAILED — ${e.data.invalid} tampered entries`,e.data.integrity==="passed"?"success":"error")}catch{t.show("Verification failed","error")}C(!1)};return r.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"24px"},children:[r.jsx(ee,{label:"Administration",title:"Activity Log"}),r.jsx(z,{children:r.jsxs("div",{style:{display:"flex",gap:"10px",alignItems:"center",flexWrap:"wrap"},children:[r.jsxs("select",{value:a,onChange:e=>{p(e.target.value),l(0)},style:{...f,minWidth:"160px"},children:[r.jsx("option",{value:"",children:"All Actions"}),V.map(e=>r.jsx("option",{value:e,children:e},e))]}),r.jsxs("select",{value:d,onChange:e=>{h(e.target.value),l(0)},style:{...f,minWidth:"140px"},children:[r.jsx("option",{value:"",children:"All Resources"}),q.map(e=>r.jsx("option",{value:e,children:e},e))]}),r.jsx("input",{value:u,onChange:e=>{S(e.target.value),l(0)},placeholder:"Filter by email...",style:{...f,flex:1,minWidth:"150px"}}),r.jsx("div",{style:{display:"flex",gap:"4px"},children:["7","30","90","all"].map(e=>r.jsx("button",{onClick:()=>M(e),style:{padding:"5px 10px",cursor:"pointer",background:k===e?"rgba(74,61,117,0.08)":"transparent",border:`1px solid ${k===e?s.purpleBright:s.borderGlass}`,color:k===e?s.purpleBright:s.textTertiary,fontFamily:s.mono,fontSize:"10px",fontWeight:600,letterSpacing:"0.08em"},children:e==="all"?"All":`${e}d`},e))}),r.jsx("input",{type:"date",value:b,onChange:e=>{j(e.target.value),l(0),T("")},style:{...f,colorScheme:"light"}}),r.jsx("span",{style:{fontSize:"11px",color:s.textTertiary},children:"to"}),r.jsx("input",{type:"date",value:v,onChange:e=>{w(e.target.value),l(0),T("")},style:{...f,colorScheme:"light"}}),r.jsxs("span",{style:{fontFamily:s.mono,fontSize:"11px",color:s.textTertiary,whiteSpace:"nowrap"},children:[R.toLocaleString()," entries",B&&!I?" ↻":""]}),r.jsx("button",{onClick:N,style:{padding:"6px 14px",background:"rgba(74,61,117,0.08)",border:"1px solid rgba(74,61,117,0.15)",color:s.purpleBright,fontFamily:s.mono,fontSize:"10px",fontWeight:600,letterSpacing:"0.08em",textTransform:"uppercase",cursor:"pointer"},children:"Export CSV"}),r.jsx("button",{onClick:H,disabled:_,style:{padding:"6px 14px",cursor:_?"wait":"pointer",fontFamily:s.mono,fontSize:"10px",fontWeight:600,letterSpacing:"0.08em",textTransform:"uppercase",background:n?n.integrity==="passed"?"rgba(22,135,62,0.08)":"rgba(180,52,52,0.08)":"rgba(74,61,117,0.08)",border:`1px solid ${n?n.integrity==="passed"?"rgba(22,135,62,0.20)":"rgba(180,52,52,0.20)":"rgba(74,61,117,0.15)"}`,color:n?n.integrity==="passed"?s.accentGreen:s.accentRed:s.purpleBright},children:_?"Verifying…":n?n.integrity==="passed"?`✓ ${n.valid} Verified`:`✗ ${n.invalid} Invalid`:"⛓ Verify Chain"})]})}),r.jsxs(z,{children:[r.jsx(te,{columns:ae,rows:G,loading:I,emptyMessage:"No audit log entries found"}),x>1&&r.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",gap:"8px",padding:"16px 0 0",borderTop:`1px solid ${s.borderSubtle}`},children:[r.jsx("button",{onClick:()=>l(e=>Math.max(0,e-1)),disabled:i===0,style:{padding:"5px 12px",background:s.cardSurface,border:`1px solid ${s.borderGlass}`,color:i===0?s.textDim:s.textPrimary,cursor:i===0?"not-allowed":"pointer",fontFamily:s.mono,fontSize:"11px"},children:"← Prev"}),r.jsxs("span",{style:{fontFamily:s.mono,fontSize:"11px",color:s.textSecondary},children:[i+1," / ",x]}),r.jsx("button",{onClick:()=>l(e=>Math.min(x-1,e+1)),disabled:i>=x-1,style:{padding:"5px 12px",background:s.cardSurface,border:`1px solid ${s.borderGlass}`,color:i>=x-1?s.textDim:s.textPrimary,cursor:i>=x-1?"not-allowed":"pointer",fontFamily:s.mono,fontSize:"11px"},children:"Next →"})]})]})]})}export{xe as default};
