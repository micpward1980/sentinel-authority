import{j as t,s as e,a as H,u as M,d as U,e as V,L as P,c as $}from"./index-CiYkEjR4.js";import{R as k,r as S,P as Y,o as K,F as Z}from"./icons-CE7UjK-E.js";import{u as J}from"./useQuery-wJN8pz4O.js";import{P as X}from"./Panel-CtACPDlF.js";import{C as ee}from"./CopyableId-Bdj8Orjw.js";import{E as te}from"./EmptyState-sxA8n5aZ.js";import"./vendor-BZ1VDJqt.js";function pe({isOpen:o,onClose:f,onImport:R,boundaryType:w}){const[x,C]=k.useState(""),[y,G]=k.useState("json"),[b,z]=k.useState(""),[i,u]=k.useState(null),g={numeric:{json:'[{"name":"Speed Limit","parameter":"speed","min_value":0,"max_value":100,"unit":"km/h","tolerance":5}]',csv:`name,parameter,min_value,max_value,hard_limit,unit,tolerance
Speed Limit,speed,0,100,120,km/h,5`},geo:{json:'[{"name":"Operating Zone","boundary_type":"circle","lat":30.123,"lon":-97.456,"radius_meters":500}]',csv:`name,boundary_type,lat,lon,radius_meters,altitude_max
Operating Zone,circle,30.123,-97.456,500,120`},time:{json:'[{"name":"Business Hours","start_hour":6,"end_hour":22,"timezone":"America/Chicago","days":[0,1,2,3,4]}]',csv:`name,start_hour,end_hour,timezone,days
Business Hours,6,22,America/Chicago,0;1;2;3;4`},state:{json:'[{"name":"Mode Check","parameter":"mode","allowed_values":"autonomous,semi-auto","forbidden_values":"manual_override"}]',csv:`name,parameter,allowed_values,forbidden_values
Mode Check,mode,"autonomous,semi-auto",manual_override`}},D=()=>{z(""),u(null);try{let r=[];if(y==="json"){const p=JSON.parse(x);r=Array.isArray(p)?p:[p]}else{const p=x.trim().split(`
`);if(p.length<2)throw new Error("CSV needs header + data rows");const s=p[0].split(",").map(m=>m.trim());r=p.slice(1).map(m=>{const N=m.match(/(".*?"|[^,]+)/g)||[],h={};return s.forEach((I,j)=>{let _=(N[j]||"").replace(/^"|"$/g,"").trim();h[I]=I==="days"?_.split(";").map(Number):_}),h})}if(!r.length)throw new Error("No data found");u(r)}catch(r){z(r.message)}};return o?t.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.4)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center",padding:"20px"},onClick:f,children:t.jsxs("div",{style:{background:e.bgDeep,border:"1px solid rgba(74,61,117,0.2)",padding:"32px",maxWidth:"min(700px, 95vw)",width:"100%",maxHeight:"80vh",overflowY:"auto"},onClick:r=>r.stopPropagation(),children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[t.jsxs("h3",{style:{fontFamily:e.serif,fontSize:"20px",fontWeight:200,margin:0},children:["Bulk Import — ",w]}),t.jsx("button",{onClick:f,style:{background:"none",border:"none",color:e.textTertiary,fontSize:"20px",cursor:"pointer"},children:"×"})]}),t.jsxs("div",{style:{display:"flex",gap:"8px",marginBottom:"16px"},children:[["json","csv"].map(r=>t.jsx("button",{onClick:()=>{G(r),z(""),u(null)},style:{padding:"6px 16px",border:`1px solid ${y===r?e.purpleBright:e.borderGlass}`,background:y===r?"rgba(74,61,117,0.08)":"transparent",color:y===r?e.purpleBright:e.textTertiary,fontFamily:e.mono,fontSize:"11px",letterSpacing:"1px",textTransform:"uppercase",cursor:"pointer"},children:r},r)),t.jsx("button",{onClick:()=>{var r;return C(((r=g[w])==null?void 0:r[y])||"")},style:{marginLeft:"auto",padding:"6px 12px",border:`1px solid ${e.borderGlass}`,background:"transparent",color:e.textTertiary,fontSize:"11px",cursor:"pointer"},children:"Load Example"})]}),t.jsx("textarea",{value:x,onChange:r=>C(r.target.value),rows:10,placeholder:y==="json"?"Paste JSON array...":"Paste CSV with header row...",style:{width:"100%",background:e.cardSurface,border:`1px solid ${e.borderGlass}`,padding:"12px",color:e.textPrimary,fontFamily:e.mono,fontSize:"12px",lineHeight:"1.5",resize:"vertical",outline:"none"}}),b&&t.jsxs("p",{style:{color:e.accentRed,fontSize:"12px",marginTop:"8px"},children:["⚠ ",b]}),t.jsxs("div",{style:{display:"flex",gap:"8px",marginTop:"16px"},children:[t.jsx("button",{onClick:D,style:{padding:"8px 20px",border:`1px solid ${e.purpleBright}`,background:"transparent",color:e.purpleBright,fontSize:"12px",cursor:"pointer"},children:"Preview"}),i&&t.jsxs("button",{onClick:()=>{R(i),f(),C(""),u(null)},style:{padding:"8px 20px",border:"none",background:"transparent",color:e.textPrimary,fontSize:"12px",cursor:"pointer",fontWeight:500},children:["Import ",i.length," ",i.length===1?"boundary":"boundaries"]})]}),i&&t.jsxs("div",{style:{marginTop:"16px",padding:"12px",maxHeight:"200px",overflowY:"auto"},children:[t.jsxs("p",{style:{fontFamily:e.mono,fontSize:"10px",color:e.textTertiary,marginBottom:"8px"},children:["PREVIEW (",i.length," rows)"]}),i.map((r,p)=>t.jsx("div",{style:{fontSize:"11px",color:e.textTertiary,padding:"4px 0",borderBottom:`1px solid ${e.borderSubtle}`},children:Object.entries(r).map(([s,m])=>`${s}: ${m}`).join(" · ")},p))]})]})}):null}function L(o){return o==="conformant"?e.accentGreen:o==="revoked"||o==="suspended"?e.accentRed:o==="testing"||o==="approved"?e.purpleBright:e.accentAmber}function ne(o){return o?new Date(o).toLocaleDateString("en-US",{timeZone:"UTC"}):"—"}const v={fontFamily:e.mono,fontSize:"11px",fontWeight:600,letterSpacing:"0.08em",textTransform:"uppercase",color:e.textTertiary,padding:"10px 16px",textAlign:"left",borderBottom:`1px solid ${e.borderGlass}`,whiteSpace:"nowrap"},d=o=>({background:e.cardSurface,border:`1px solid ${e.borderSubtle}`,color:o,fontFamily:e.mono,fontSize:"9px",letterSpacing:"0.06em",textTransform:"uppercase",cursor:"pointer",padding:"3px 8px"}),re=[{key:"all",label:"All"},{key:"pending",label:"Pending"},{key:"under_review",label:"Review"},{key:"approved",label:"Approved"},{key:"testing",label:"Testing"},{key:"conformant",label:"Conformant"},{key:"revoked",label:"Suspended"}];function xe(){const o=H(),{user:f}=M(),R=U(),w=V(),[x,C]=S.useState("all"),[y,G]=S.useState(""),[b,z]=S.useState(""),[i,u]=S.useState(new Set),[g,D]=S.useState(!1),r=k.useRef(null),p=n=>{G(n),clearTimeout(r.current),r.current=k.useRef(setTimeout(()=>z(n),300)).current},{data:s,isLoading:m,isFetching:N}=J({queryKey:["applications",x,b],queryFn:()=>{const n={};return b&&(n.search=b),x&&x!=="all"&&(n.state=x),$.get("/api/applications/",{params:n}).then(a=>a.data)},keepPreviousData:!0}),h=(s==null?void 0:s.applications)??s??[],I=(s==null?void 0:s.total)??h.length,j=(s==null?void 0:s.state_counts)??{},_=()=>w.invalidateQueries({queryKey:["applications"]}),O=n=>{w.prefetchQuery({queryKey:["application",n],queryFn:()=>$.get(`/api/applications/${n}`).then(a=>a.data),staleTime:3e4})},Q=S.useCallback(n=>u(a=>{const l=new Set(a);return l.has(n)?l.delete(n):l.add(n),l}),[]),q=()=>u(new Set(h.map(n=>n.id))),E=()=>u(new Set),T=async(n,a)=>{var B,F;const l=[...i];if(l.length&&await R({title:"Confirm",message:`${n} ${l.length} application(s)?`})){D(!0);try{n==="delete"?await $.post("/api/applications/bulk-delete",{ids:l}):await $.post("/api/applications/bulk-state",{ids:l,new_state:a}),u(new Set),_()}catch(A){o.show("Bulk operation failed: "+(((F=(B=A.response)==null?void 0:B.data)==null?void 0:F.detail)||A.message),"error")}D(!1)}},W=async(n,a,l)=>{var B,F;if(await R({title:"Confirm",message:l+"?"}))try{await $.patch(`/api/applications/${n}/state?new_state=${a}`),_()}catch(A){o.show("Failed: "+(((F=(B=A.response)==null?void 0:B.data)==null?void 0:F.detail)||A.message),"error")}},c=(f==null?void 0:f.role)==="admin";return t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"24px"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",flexWrap:"wrap",gap:"16px"},children:[t.jsxs("div",{children:[t.jsx("p",{style:{fontFamily:e.mono,fontSize:"10px",letterSpacing:"4px",textTransform:"uppercase",color:e.purpleBright,marginBottom:"8px"},children:c?"Conformance":"My Organization"}),t.jsx("h1",{style:{fontFamily:e.serif,fontSize:"clamp(24px, 5vw, 36px)",fontWeight:200,margin:0},children:c?"Applications":"Certification Status"})]}),t.jsxs(P,{to:"/applications/new",className:"inline-flex items-center gap-2 px-4 py-2 no-underline",style:{background:"transparent",border:"none",borderBottom:"1px solid "+e.purpleBright,color:e.purpleBright,fontFamily:e.mono,fontSize:"11px",letterSpacing:"1px",textTransform:"uppercase",cursor:"pointer",alignSelf:"center"},children:[t.jsx(Y,{className:"w-4 h-4"})," New Application"]}),N&&!m&&t.jsx("span",{style:{fontFamily:e.mono,fontSize:"10px",color:e.textDim,alignSelf:"center"},children:"Updating…"})]}),c&&t.jsxs("div",{style:{display:"flex",gap:"12px",alignItems:"center",flexWrap:"wrap"},children:[t.jsxs("div",{style:{position:"relative",flex:1,maxWidth:"min(400px, 90vw)"},children:[t.jsx(K,{size:14,style:{position:"absolute",left:"12px",top:"50%",transform:"translateY(-50%)",color:e.textTertiary}}),t.jsx("input",{value:y,onChange:n=>p(n.target.value),placeholder:"Search by name, org, or ID...",style:{width:"100%",background:e.cardSurface,border:`1px solid ${e.borderGlass}`,padding:"8px 12px 8px 36px",color:e.textPrimary,fontSize:"13px",fontFamily:e.mono,outline:"none"}})]}),t.jsxs("span",{style:{fontFamily:e.mono,fontSize:"11px",color:e.textTertiary},children:[h.length," of ",I]})]}),c&&t.jsx("div",{style:{display:"flex",gap:"4px",flexWrap:"wrap"},children:re.map(n=>{const a=n.key==="all"?j.all||0:n.key==="revoked"?(j.suspended||0)+(j.revoked||0):j[n.key]||0,l=x===n.key;return t.jsxs("button",{onClick:()=>C(n.key),style:{padding:"6px 14px",cursor:"pointer",fontFamily:e.mono,fontSize:"10px",fontWeight:600,letterSpacing:"0.08em",textTransform:"uppercase",background:l?"rgba(74,61,117,0.10)":"transparent",border:`1px solid ${l?e.purpleBright:e.borderGlass}`,color:l?e.purpleBright:e.textTertiary},children:[n.label,a>0?` (${a})`:""]},n.key)})}),t.jsxs(X,{children:[t.jsx("div",{style:{overflowX:"auto",WebkitOverflowScrolling:"touch"},children:t.jsxs("table",{style:{width:"100%",minWidth:"700px",borderCollapse:"collapse"},children:[t.jsx("thead",{children:t.jsxs("tr",{children:[c&&t.jsx("th",{style:{...v,width:"40px",textAlign:"center"},children:t.jsx("input",{type:"checkbox",checked:i.size>0&&i.size===h.length,onChange:n=>n.target.checked?q():E(),style:{cursor:"pointer",accentColor:e.purpleBright}})}),t.jsx("th",{style:v,children:"System Name"}),c&&t.jsx("th",{style:v,children:"Organization"}),t.jsx("th",{style:v,children:"State"}),t.jsx("th",{style:v,children:"Submitted (UTC)"}),c&&t.jsx("th",{style:v,children:"Actions"})]})}),t.jsx("tbody",{children:m?t.jsx("tr",{children:t.jsx("td",{colSpan:c?6:3,style:{padding:"40px",textAlign:"center",fontFamily:e.mono,fontSize:"11px",color:e.textDim},children:"LOADING..."})}):h.map(n=>{var a;return t.jsxs("tr",{onMouseEnter:()=>O(n.id),style:{borderBottom:`1px solid ${e.borderSubtle}`,background:i.has(n.id)?"rgba(74,61,117,0.04)":"transparent"},children:[c&&t.jsx("td",{style:{padding:"12px 8px",textAlign:"center"},children:t.jsx("input",{type:"checkbox",checked:i.has(n.id),onChange:()=>Q(n.id),style:{cursor:"pointer",accentColor:e.purpleBright}})}),t.jsxs("td",{style:{padding:"12px 16px"},children:[t.jsx(P,{to:`/applications/${n.id}`,style:{color:e.purpleBright,textDecoration:"none",fontWeight:500},children:n.system_name}),t.jsx(ee,{id:n.application_number,style:{fontSize:"11px",color:e.textDim}})]}),c&&t.jsx("td",{style:{padding:"12px 16px",color:e.textSecondary,fontSize:"13px"},children:n.organization_name}),t.jsx("td",{style:{padding:"12px 16px"},children:t.jsx("span",{style:{fontFamily:e.mono,fontSize:"10px",fontWeight:600,letterSpacing:"0.08em",textTransform:"uppercase",padding:"2px 8px",background:`${L(n.state)}10`,color:L(n.state)},children:(a=n.state)==null?void 0:a.replace("_"," ")})}),t.jsx("td",{style:{padding:"12px 16px",color:e.textTertiary,fontSize:"13px",fontFamily:e.mono},children:ne(n.submitted_at)}),c&&t.jsx("td",{style:{padding:"12px 16px"},children:t.jsxs("div",{style:{display:"flex",gap:"6px",flexWrap:"wrap"},children:[n.state==="pending"&&t.jsx("button",{onClick:()=>W(n.id,"under_review",`Begin review for ${n.system_name}`),style:d(e.accentAmber),children:"Review"}),(n.state==="pending"||n.state==="under_review")&&t.jsx("button",{onClick:()=>W(n.id,"approved",`Approve ${n.system_name}`),style:d(e.accentGreen),children:"Approve"}),n.state==="approved"&&t.jsx(P,{to:`/applications/${n.id}`,style:{...d(e.purpleBright),textDecoration:"none"},children:"Schedule Test"}),n.state==="testing"&&t.jsx(P,{to:"/cat72",style:{...d(e.purpleBright),textDecoration:"none"},children:"View Test"}),n.state==="conformant"&&t.jsx("span",{style:{fontFamily:e.mono,fontSize:"9px",color:e.accentGreen},children:"✓ Certified"}),["pending","under_review","approved","testing","conformant"].includes(n.state)&&t.jsx("button",{onClick:()=>W(n.id,"suspended",`Suspend ${n.system_name}`),style:d(e.accentRed),children:"Suspend"}),(n.state==="suspended"||n.state==="revoked")&&t.jsx("button",{onClick:()=>W(n.id,"pending",`Reinstate ${n.system_name}`),style:d(e.accentGreen),children:"Reinstate"})]})})]},n.id)})})]})}),i.size>0&&c&&t.jsxs("div",{style:{position:"sticky",bottom:"16px",zIndex:50,display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:"12px",padding:"12px 20px",margin:"16px 0 0",background:"rgba(0,0,0,0.92)",backdropFilter:"blur(12px)",border:`1px solid ${e.purpleBright}`},children:[t.jsxs("span",{style:{fontFamily:e.mono,fontSize:"12px",color:e.purpleBright},children:[i.size," selected"]}),t.jsxs("div",{style:{display:"flex",gap:"8px",alignItems:"center"},children:[t.jsx("button",{onClick:()=>T("approve","approved"),disabled:g,style:d(e.accentGreen),children:"Approve"}),t.jsx("button",{onClick:()=>T("review","under_review"),disabled:g,style:d(e.accentAmber),children:"Review"}),t.jsx("button",{onClick:()=>T("suspend","suspended"),disabled:g,style:d(e.accentRed),children:"Suspend"}),t.jsx("button",{onClick:()=>T("reinstate","pending"),disabled:g,style:d(e.accentGreen),children:"Reinstate"}),t.jsx("div",{style:{width:"1px",height:"20px",background:e.borderGlass,borderRadius:8}}),t.jsx("button",{onClick:()=>T("delete"),disabled:g,style:d(e.accentRed),children:"Delete"}),t.jsx("button",{onClick:E,style:d(e.textTertiary),children:"Cancel"}),g&&t.jsx("span",{style:{fontFamily:e.mono,fontSize:"10px",color:e.textDim},children:"Processing…"})]})]}),!m&&h.length===0&&t.jsx(te,{icon:Z,title:"No Applications Found",description:s?"No applications match your current filter.":"You haven't submitted any certification applications yet."})]})]})}export{pe as BulkImportModal,xe as default};
