import{u as ie,a as re,g as I,j as i,s as t,d as f}from"./index-BlCiafsT.js";import{r as a}from"./icons-DCxkC3Ow.js";import{P as L}from"./Panel-p42_iV9w.js";import{S as ae}from"./SectionHeader-Dj1td-uE.js";import ne from"./MyActivityPage-DkYYFYzF.js";import{D as oe,B as le}from"./Badge-DOfG_5JD.js";import"./vendor-DxYwK_Rn.js";function ce(s){return s?new Date(s).toISOString().replace("T"," ").substring(0,19)+"Z":"—"}function de(s){return s?s.includes("issued")||s.includes("approved")||s.includes("conformant")?"green":s.includes("suspended")||s.includes("revoked")||s.includes("failed")?"red":s.includes("pending")||s.includes("under_review")?"amber":"purple":"dim"}function O({actionFilter:s,resourceFilter:l,emailFilter:m,dateFrom:S,dateTo:c,page:u,limit:b}){const r=new URLSearchParams;return s&&r.set("action",s),l&&r.set("resource_type",l),m&&r.set("user_email",m),S&&r.set("date_from",new Date(S).toISOString()),c&&r.set("date_to",new Date(c+"T23:59:59").toISOString()),r.set("limit",b),r.set("offset",u*b),r.toString()}const U=50,h={background:t.cardSurface,border:`1px solid ${t.borderGlass}`,padding:"7px 12px",color:t.textPrimary,fontSize:"12px",fontFamily:t.mono,outline:"none"},pe=[{key:"timestamp",label:"Timestamp (UTC)",style:{whiteSpace:"nowrap",fontFamily:t.mono,fontSize:"11px",color:t.textSecondary},render:s=>ce(s.timestamp)},{key:"user_email",label:"User",render:s=>s.user_email||"—"},{key:"action",label:"Action",render:s=>i.jsx(le,{variant:de(s.action),children:s.action})},{key:"resource",label:"Resource",style:{fontFamily:t.mono,fontSize:"11px",color:t.textTertiary},render:s=>s.resource_type?`${s.resource_type}${s.resource_id?` #${s.resource_id}`:""}`:"—"},{key:"details",label:"Details",style:{maxWidth:"280px",fontSize:"12px"},render:s=>s.details?Object.entries(s.details).filter(([l])=>l!=="old_state").map(([l,m])=>i.jsxs("span",{style:{marginRight:"10px"},children:[i.jsxs("span",{style:{color:t.textTertiary},children:[l.replace(/_/g," "),":"]})," ",i.jsx("span",{style:{color:t.textSecondary},children:String(m)})]},l)):"—"},{key:"log_hash",label:"Hash",style:{fontFamily:t.mono,fontSize:"10px",color:t.textDim,letterSpacing:"0.04em",maxWidth:"120px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},render:s=>s.log_hash?s.log_hash.substring(0,16)+"…":"—"}];function be(){const{user:s}=ie(),[l,m]=a.useState("all"),S=(s==null?void 0:s.role)==="admin",c=re(),[u,b]=a.useState(""),[r,V]=a.useState(""),[v,E]=a.useState(""),[o,d]=a.useState(0),[j,k]=a.useState(""),[w,T]=a.useState(""),[_,D]=a.useState("30"),[n,q]=a.useState(null),[F,R]=a.useState(!1),{data:W}=I({queryKey:["audit-actions"],queryFn:()=>f.get("/api/audit/actions").then(e=>e.data.actions||[]),staleTime:1/0}),{data:B}=I({queryKey:["audit-resources"],queryFn:()=>f.get("/api/audit/resource-types").then(e=>e.data.resource_types||[]),staleTime:1/0}),G=W??[],M=B??[],N=["audit-logs",u,r,v,j,w,o],{data:g,isLoading:A,isFetching:H}=I({queryKey:N,queryFn:()=>{const e=O({actionFilter:u,resourceFilter:r,emailFilter:v,dateFrom:j,dateTo:w,page:o,limit:U});return f.get(`/api/audit/logs?${e}`).then(y=>y.data)},keepPreviousData:!0}),K=(g==null?void 0:g.logs)??[],P=(g==null?void 0:g.total)??0,x=Math.ceil(P/U),Q=a.useCallback(e=>{if(D(e),d(0),e==="all")k(""),T("");else{const y=new Date;y.setDate(y.getDate()-parseInt(e)),k(y.toISOString().split("T")[0]),T("")}},[]),Z=async()=>{try{const e=O({actionFilter:u,resourceFilter:r,emailFilter:v,dateFrom:j,dateTo:w,page:0,limit:1e4}),$=(await f.get(`/api/audit/logs?${e}`)).data.logs||[];if(!$.length){c.show("No entries to export","warning");return}const X=["Timestamp,User,Action,Resource Type,Resource ID,Details,Hash",...$.map(p=>{const ee=p.details?Object.entries(p.details).map(([te,se])=>`${te}=${se}`).join("; "):"";return[p.timestamp||"",p.user_email||"",p.action||"",p.resource_type||"",p.resource_id||"",`"${ee.replace(/"/g,'""')}"`,p.log_hash||""].join(",")})].join(`
`),Y=new Blob([X],{type:"text/csv"}),z=URL.createObjectURL(Y),C=document.createElement("a");C.href=z,C.download=`audit-log-${new Date().toISOString().split("T")[0]}.csv`,C.click(),URL.revokeObjectURL(z),c.show(`CSV exported (${$.length} entries)`,"success")}catch{c.show("Export failed","error")}},J=async()=>{R(!0);try{const e=await f.get("/api/audit/verify?limit=5000");q(e.data),c.show(e.data.integrity==="passed"?`Integrity verified — ${e.data.valid} entries valid`:`Integrity check FAILED — ${e.data.invalid} tampered entries`,e.data.integrity==="passed"?"success":"error")}catch{c.show("Verification failed","error")}R(!1)};return S?i.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"24px"},children:[i.jsx(ae,{label:"Administration",title:"Activity Log"}),i.jsx(L,{children:i.jsxs("div",{style:{display:"flex",gap:"10px",alignItems:"center",flexWrap:"wrap"},children:[i.jsxs("select",{value:u,onChange:e=>{b(e.target.value),d(0)},style:{...h,minWidth:"160px"},children:[i.jsx("option",{value:"",children:"All Actions"}),G.map(e=>i.jsx("option",{value:e,children:e},e))]}),i.jsxs("select",{value:r,onChange:e=>{V(e.target.value),d(0)},style:{...h,minWidth:"140px"},children:[i.jsx("option",{value:"",children:"All Resources"}),M.map(e=>i.jsx("option",{value:e,children:e},e))]}),i.jsx("input",{value:v,onChange:e=>{E(e.target.value),d(0)},placeholder:"Filter by email...",style:{...h,flex:1,minWidth:"150px"}}),i.jsx("div",{style:{display:"flex",gap:"4px"},children:["7","30","90","all"].map(e=>i.jsx("button",{onClick:()=>Q(e),style:{padding:"5px 10px",cursor:"pointer",background:_===e?"rgba(29,26,59,0.08)":"transparent",border:`1px solid ${_===e?t.purpleBright:t.borderGlass}`,color:_===e?t.purpleBright:t.textTertiary,fontFamily:t.mono,fontSize:"10px",fontWeight:600,letterSpacing:"0.08em"},children:e==="all"?"All":`${e}d`},e))}),i.jsx("input",{type:"date",value:j,onChange:e=>{k(e.target.value),d(0),D("")},style:{...h,colorScheme:"light"}}),i.jsx("span",{style:{fontSize:"11px",color:t.textTertiary},children:"to"}),i.jsx("input",{type:"date",value:w,onChange:e=>{T(e.target.value),d(0),D("")},style:{...h,colorScheme:"light"}}),i.jsxs("span",{style:{fontFamily:t.mono,fontSize:"11px",color:t.textTertiary,whiteSpace:"nowrap"},children:[P.toLocaleString()," entries",H&&!A?" ↻":""]}),i.jsx("button",{onClick:Z,style:{padding:"6px 14px",background:"rgba(29,26,59,0.08)",border:"1px solid rgba(29,26,59,0.15)",color:t.purpleBright,fontFamily:t.mono,fontSize:"10px",fontWeight:600,letterSpacing:"0.08em",textTransform:"uppercase",cursor:"pointer"},children:"Export CSV"}),i.jsx("button",{onClick:J,disabled:F,style:{padding:"6px 14px",cursor:F?"wait":"pointer",fontFamily:t.mono,fontSize:"10px",fontWeight:600,letterSpacing:"0.08em",textTransform:"uppercase",background:n?n.integrity==="passed"?"rgba(22,135,62,0.08)":"rgba(180,52,52,0.08)":"rgba(29,26,59,0.08)",border:`1px solid ${n?n.integrity==="passed"?"rgba(22,135,62,0.20)":"rgba(180,52,52,0.20)":"rgba(29,26,59,0.15)"}`,color:n?n.integrity==="passed"?t.accentGreen:t.accentRed:t.purpleBright},children:F?"Verifying…":n?n.integrity==="passed"?`✓ ${n.valid} Verified`:`✗ ${n.invalid} Invalid`:"⛓ Verify Chain"})]})}),i.jsxs(L,{children:[i.jsx(oe,{columns:pe,rows:K,loading:A,emptyMessage:"No audit log entries found"}),x>1&&i.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",gap:"8px",padding:"16px 0 0",borderTop:`1px solid ${t.borderSubtle}`},children:[i.jsx("button",{onClick:()=>d(e=>Math.max(0,e-1)),disabled:o===0,style:{padding:"5px 12px",background:t.cardSurface,border:`1px solid ${t.borderGlass}`,color:o===0?t.textDim:t.textPrimary,cursor:o===0?"not-allowed":"pointer",fontFamily:t.mono,fontSize:"11px"},children:"← Prev"}),i.jsxs("span",{style:{fontFamily:t.mono,fontSize:"11px",color:t.textSecondary},children:[o+1," / ",x]}),i.jsx("button",{onClick:()=>d(e=>Math.min(x-1,e+1)),disabled:o>=x-1,style:{padding:"5px 12px",background:t.cardSurface,border:`1px solid ${t.borderGlass}`,color:o>=x-1?t.textDim:t.textPrimary,cursor:o>=x-1?"not-allowed":"pointer",fontFamily:t.mono,fontSize:"11px"},children:"Next →"})]})]})]}):i.jsx(ne,{})}export{be as default};
