import{j as t,s as e,a as H,u as U,e as V,f as Y,c as K,L as P,d as A}from"./index-CQToRwbo.js";import{R as $,r as v,P as Z,l as J,F as X}from"./icons-DCxkC3Ow.js";import{u as ee}from"./useQuery-DvUtKwTH.js";import{P as te}from"./Panel-CTXV6eYW.js";import{C as ne}from"./CopyableId-DLd-jDZI.js";import{E as re}from"./EmptyState-CEDHeoAn.js";import"./vendor-DxYwK_Rn.js";function ue({isOpen:i,onClose:g,onImport:D,boundaryType:w}){const[f,x]=$.useState(""),[h,G]=$.useState("json"),[R,b]=$.useState(""),[u,l]=$.useState(null),S={numeric:{json:'[{"name":"Speed Limit","parameter":"speed","min_value":0,"max_value":100,"unit":"km/h","tolerance":5}]',csv:`name,parameter,min_value,max_value,hard_limit,unit,tolerance
Speed Limit,speed,0,100,120,km/h,5`},geo:{json:'[{"name":"Operating Zone","boundary_type":"circle","lat":30.123,"lon":-97.456,"radius_meters":500}]',csv:`name,boundary_type,lat,lon,radius_meters,altitude_max
Operating Zone,circle,30.123,-97.456,500,120`},time:{json:'[{"name":"Business Hours","start_hour":6,"end_hour":22,"timezone":"America/Chicago","days":[0,1,2,3,4]}]',csv:`name,start_hour,end_hour,timezone,days
Business Hours,6,22,America/Chicago,0;1;2;3;4`},state:{json:'[{"name":"Mode Check","parameter":"mode","allowed_values":"autonomous,semi-auto","forbidden_values":"manual_override"}]',csv:`name,parameter,allowed_values,forbidden_values
Mode Check,mode,"autonomous,semi-auto",manual_override`}},y=()=>{b(""),l(null);try{let r=[];if(h==="json"){const c=JSON.parse(f);r=Array.isArray(c)?c:[c]}else{const c=f.trim().split(`
`);if(c.length<2)throw new Error("CSV needs header + data rows");const C=c[0].split(",").map(o=>o.trim());r=c.slice(1).map(o=>{const z=o.match(/(".*?"|[^,]+)/g)||[],I={};return C.forEach((m,E)=>{let j=(z[E]||"").replace(/^"|"$/g,"").trim();I[m]=m==="days"?j.split(";").map(Number):j}),I})}if(!r.length)throw new Error("No data found");l(r)}catch(r){b(r.message)}};return i?t.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.4)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center",padding:"20px"},onClick:g,children:t.jsxs("div",{style:{background:e.bgDeep,border:"1px solid rgba(29,26,59,0.2)",padding:"32px",maxWidth:"min(700px, 95vw)",width:"100%",maxHeight:"80vh",overflowY:"auto"},onClick:r=>r.stopPropagation(),children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[t.jsxs("h3",{style:{fontFamily:e.serif,fontSize:"20px",fontWeight:200,margin:0},children:["Bulk Import — ",w]}),t.jsx("button",{onClick:g,style:{background:"none",border:"none",color:e.textTertiary,fontSize:"20px",cursor:"pointer"},children:"×"})]}),t.jsxs("div",{style:{display:"flex",gap:"8px",marginBottom:"16px"},children:[["json","csv"].map(r=>t.jsx("button",{onClick:()=>{G(r),b(""),l(null)},style:{padding:"6px 16px",border:`1px solid ${h===r?e.purpleBright:e.borderGlass}`,background:h===r?"rgba(29,26,59,0.08)":"transparent",color:h===r?e.purpleBright:e.textTertiary,fontFamily:e.mono,fontSize:"11px",letterSpacing:"1px",textTransform:"uppercase",cursor:"pointer"},children:r},r)),t.jsx("button",{onClick:()=>{var r;return x(((r=S[w])==null?void 0:r[h])||"")},style:{marginLeft:"auto",padding:"6px 12px",border:`1px solid ${e.borderGlass}`,background:"transparent",color:e.textTertiary,fontSize:"11px",cursor:"pointer"},children:"Load Example"})]}),t.jsx("textarea",{value:f,onChange:r=>x(r.target.value),rows:10,placeholder:h==="json"?"Paste JSON array...":"Paste CSV with header row...",style:{width:"100%",background:e.cardSurface,border:`1px solid ${e.borderGlass}`,padding:"12px",color:e.textPrimary,fontFamily:e.mono,fontSize:"12px",lineHeight:"1.5",resize:"vertical",outline:"none"}}),R&&t.jsxs("p",{style:{color:e.accentRed,fontSize:"12px",marginTop:"8px"},children:["⚠ ",R]}),t.jsxs("div",{style:{display:"flex",gap:"8px",marginTop:"16px"},children:[t.jsx("button",{onClick:y,style:{padding:"8px 20px",border:"none",borderBottom:`1px solid ${e.purpleBright}`,background:"transparent",color:e.purpleBright,fontSize:"12px",cursor:"pointer"},children:"Preview"}),u&&t.jsxs("button",{onClick:()=>{D(u),g(),x(""),l(null)},style:{padding:"8px 20px",border:"none",background:"transparent",color:e.textPrimary,fontSize:"12px",cursor:"pointer",fontWeight:500},children:["Import ",u.length," ",u.length===1?"boundary":"boundaries"]})]}),u&&t.jsxs("div",{style:{marginTop:"16px",padding:"12px",maxHeight:"200px",overflowY:"auto"},children:[t.jsxs("p",{style:{fontFamily:e.mono,fontSize:"10px",color:e.textTertiary,marginBottom:"8px"},children:["PREVIEW (",u.length," rows)"]}),u.map((r,c)=>t.jsx("div",{style:{fontSize:"11px",color:e.textTertiary,padding:"4px 0",borderBottom:`1px solid ${e.borderSubtle}`},children:Object.entries(r).map(([C,o])=>`${C}: ${o}`).join(" · ")},c))]})]})}):null}function O(i){return i==="conformant"?e.accentGreen:i==="revoked"||i==="suspended"?e.accentRed:i==="testing"||i==="approved"?e.purpleBright:e.accentAmber}function oe(i){return i?new Date(i).toLocaleDateString("en-US",{timeZone:"UTC"}):"—"}const k={fontFamily:e.mono,fontSize:"11px",fontWeight:600,letterSpacing:"0.08em",textTransform:"uppercase",color:e.textTertiary,padding:"10px 16px",textAlign:"left",borderBottom:`1px solid ${e.borderGlass}`,whiteSpace:"nowrap"},p=i=>({background:e.cardSurface,border:`1px solid ${e.borderSubtle}`,color:i,fontFamily:e.mono,fontSize:"9px",letterSpacing:"0.06em",textTransform:"uppercase",cursor:"pointer",padding:"3px 8px"}),ie=[{key:"all",label:"All"},{key:"pending",label:"Pending"},{key:"under_review",label:"Review"},{key:"approved",label:"Approved"},{key:"testing",label:"Testing"},{key:"conformant",label:"Conformant"},{key:"revoked",label:"Suspended"}];function me(){const i=H(),{user:g}=U(),D=V(),w=Y(),f=K(),[x,h]=v.useState("all"),[G,R]=v.useState(""),[b,u]=v.useState(""),[l,S]=v.useState(new Set),[y,r]=v.useState(!1),c=$.useRef(null),C=n=>{R(n),clearTimeout(c.current),c.current=setTimeout(()=>u(n),150)},{data:o,isLoading:z,isFetching:I}=ee({queryKey:["applications",x,b],queryFn:()=>{const n={};return b&&(n.search=b),x&&x!=="all"&&(n.state=x),A.get("/api/applications/",{params:n}).then(s=>s.data)},keepPreviousData:!0}),m=(o==null?void 0:o.applications)??o??[],E=(o==null?void 0:o.total)??m.length,j=(o==null?void 0:o.state_counts)??{},L=()=>w.invalidateQueries({queryKey:["applications"]}),M=n=>{w.prefetchQuery({queryKey:["application",n],queryFn:()=>A.get(`/api/applications/${n}`).then(s=>s.data),staleTime:3e4})},Q=v.useCallback(n=>S(s=>{const a=new Set(s);return a.has(n)?a.delete(n):a.add(n),a}),[]),q=()=>S(new Set(m.map(n=>n.id))),N=()=>S(new Set),_=async(n,s)=>{var T,B;const a=[...l];if(a.length&&await D({title:"Confirm",message:`${n} ${a.length} application(s)?`})){r(!0);try{n==="delete"?await A.post("/api/applications/bulk-delete",{ids:a}):await A.post("/api/applications/bulk-state",{ids:a,new_state:s}),S(new Set),L()}catch(F){i.show("Bulk operation failed: "+(((B=(T=F.response)==null?void 0:T.data)==null?void 0:B.detail)||F.message),"error")}r(!1)}},W=async(n,s,a)=>{var T,B;if(await D({title:"Confirm",message:a+"?"}))try{await A.patch(`/api/applications/${n}/state?new_state=${s}`),L()}catch(F){i.show("Failed: "+(((B=(T=F.response)==null?void 0:T.data)==null?void 0:B.detail)||F.message),"error")}},d=(g==null?void 0:g.role)==="admin";return t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"24px"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",flexWrap:"wrap",gap:"16px"},children:[t.jsxs("div",{children:[t.jsx("p",{style:{fontFamily:e.mono,fontSize:"10px",fontWeight:600,letterSpacing:"0.20em",textTransform:"uppercase",color:e.purpleBright,margin:"0 0 8px 0"},children:d?"Conformance":"My Organization"}),t.jsx("h1",{style:{fontFamily:e.serif,fontSize:"clamp(24px, 5vw, 36px)",fontWeight:200,margin:0,color:e.textPrimary},children:d?"Applications":"Certification Status"})]}),t.jsxs(P,{to:"/applications/new",className:"no-underline",style:{display:"inline-flex",alignItems:"center",gap:"8px",padding:"10px 20px",background:e.purplePrimary,borderRadius:"6px",color:"#fff",fontFamily:e.mono,fontSize:"10px",fontWeight:700,letterSpacing:"0.15em",textTransform:"uppercase",textDecoration:"none",cursor:"pointer"},children:[t.jsx(Z,{size:12})," New Application"]}),I&&!z&&t.jsx("span",{style:{fontFamily:e.mono,fontSize:"10px",color:e.textDim,alignSelf:"center"},children:"Updating…"})]}),d&&t.jsxs("div",{style:{display:"flex",gap:"12px",alignItems:"center",flexWrap:"wrap"},children:[t.jsxs("div",{style:{position:"relative",flex:1,maxWidth:"min(400px, 90vw)"},children:[t.jsx(J,{size:14,style:{position:"absolute",left:"12px",top:"50%",transform:"translateY(-50%)",color:e.textTertiary}}),t.jsx("input",{value:G,onChange:n=>C(n.target.value),placeholder:"Search by name, org, or ID...",style:{width:"100%",background:e.cardSurface,border:`1px solid ${e.borderGlass}`,padding:"8px 12px 8px 36px",color:e.textPrimary,fontSize:"13px",fontFamily:e.mono,outline:"none"}})]}),t.jsxs("span",{style:{fontFamily:e.mono,fontSize:"11px",color:e.textTertiary},children:[m.length," of ",E]})]}),d&&t.jsx("div",{style:{display:"flex",gap:"4px",flexWrap:"wrap"},children:ie.map(n=>{const s=n.key==="all"?j.all||0:n.key==="revoked"?(j.suspended||0)+(j.revoked||0):j[n.key]||0,a=x===n.key;return t.jsxs("button",{onClick:()=>h(n.key),style:{padding:"6px 14px",cursor:"pointer",fontFamily:e.mono,fontSize:"10px",fontWeight:600,letterSpacing:"0.08em",textTransform:"uppercase",background:a?"rgba(29,26,59,0.10)":"transparent",border:`1px solid ${a?e.purpleBright:e.borderGlass}`,color:a?e.purpleBright:e.textTertiary},children:[n.label,s>0?` (${s})`:""]},n.key)})}),t.jsxs(te,{children:[t.jsx("div",{style:{overflowX:"auto",WebkitOverflowScrolling:"touch"},children:t.jsxs("table",{style:{width:"100%",minWidth:"700px",borderCollapse:"collapse"},children:[t.jsx("thead",{children:t.jsxs("tr",{children:[d&&t.jsx("th",{style:{...k,width:"40px",textAlign:"center"},children:t.jsx("input",{type:"checkbox",checked:l.size>0&&l.size===m.length,onChange:n=>n.target.checked?q():N(),style:{cursor:"pointer",accentColor:e.purpleBright}})}),t.jsx("th",{style:k,children:"System Name"}),d&&t.jsx("th",{style:k,children:"Organization"}),t.jsx("th",{style:k,children:"State"}),t.jsx("th",{style:k,children:"Submitted (UTC)"}),d&&t.jsx("th",{style:k,children:"Actions"})]})}),t.jsx("tbody",{children:z?t.jsx("tr",{children:t.jsx("td",{colSpan:d?6:3,style:{padding:"40px",textAlign:"center",fontFamily:e.mono,fontSize:"11px",color:e.textDim},children:"LOADING..."})}):m.map(n=>{var s;return t.jsxs("tr",{onMouseEnter:()=>M(n.id),style:{borderBottom:`1px solid ${e.borderSubtle}`,background:l.has(n.id)?"rgba(29,26,59,0.04)":"transparent"},children:[d&&t.jsx("td",{style:{padding:"12px 8px",textAlign:"center"},children:t.jsx("input",{type:"checkbox",checked:l.has(n.id),onChange:()=>Q(n.id),style:{cursor:"pointer",accentColor:e.purpleBright}})}),t.jsxs("td",{style:{padding:"12px 16px"},children:[t.jsx(P,{to:`/applications/${n.id}`,style:{color:e.purpleBright,textDecoration:"none",fontWeight:500},children:n.system_name}),t.jsx(ne,{id:n.application_number,style:{fontSize:"11px",color:e.textDim}})]}),d&&t.jsx("td",{style:{padding:"12px 16px",color:e.textSecondary,fontSize:"13px"},children:n.organization_name}),t.jsx("td",{style:{padding:"12px 16px"},children:t.jsx("span",{style:{fontFamily:e.mono,fontSize:"10px",fontWeight:600,letterSpacing:"0.08em",textTransform:"uppercase",padding:"2px 8px",background:`${O(n.state)}10`,color:O(n.state)},children:(s=n.state)==null?void 0:s.replace("_"," ")})}),t.jsx("td",{style:{padding:"12px 16px",color:e.textTertiary,fontSize:"13px",fontFamily:e.mono},children:oe(n.submitted_at)}),d&&t.jsx("td",{style:{padding:"12px 16px"},children:t.jsxs("div",{style:{display:"flex",gap:"6px",flexWrap:"wrap"},children:[n.state==="pending"&&t.jsx("button",{onClick:()=>W(n.id,"under_review",`Begin review for ${n.system_name}`),style:p(e.accentAmber),children:"Review"}),(n.state==="pending"||n.state==="under_review")&&t.jsx("button",{onClick:()=>W(n.id,"approved",`Approve ${n.system_name}`),style:p(e.accentGreen),children:"Approve"}),n.state==="approved"&&t.jsx(P,{to:`/applications/${n.id}`,style:{...p(e.purpleBright),textDecoration:"none"},children:"Schedule Test"}),n.state==="testing"&&t.jsx(P,{to:"/cat72",style:{...p(e.purpleBright),textDecoration:"none"},children:"View Test"}),n.state==="conformant"&&t.jsx("span",{style:{fontFamily:e.mono,fontSize:"9px",color:e.accentGreen},children:"✓ Certified"}),["pending","under_review","approved","testing","conformant"].includes(n.state)&&t.jsx("button",{onClick:()=>W(n.id,"suspended",`Suspend ${n.system_name}`),style:p(e.accentRed),children:"Suspend"}),(n.state==="suspended"||n.state==="revoked")&&t.jsx("button",{onClick:()=>W(n.id,"pending",`Reinstate ${n.system_name}`),style:p(e.accentGreen),children:"Reinstate"})]})})]},n.id)})})]})}),l.size>0&&d&&t.jsxs("div",{style:{position:"sticky",bottom:"16px",zIndex:50,display:"flex",alignItems:"center",justifyContent:"space-between",flexDirection:f?"column":"row",gap:"12px",padding:f?"12px 14px":"12px 20px",margin:"16px 0 0",background:"rgba(0,0,0,0.92)",backdropFilter:"blur(12px)",border:"none",borderBottom:`1px solid ${e.purpleBright}`},children:[t.jsxs("span",{style:{fontFamily:e.mono,fontSize:"12px",color:e.purpleBright},children:[l.size," selected"]}),t.jsxs("div",{style:{display:"flex",gap:"6px",alignItems:"center",flexWrap:"wrap",justifyContent:f?"center":"flex-end"},children:[t.jsx("button",{onClick:()=>_("approve","approved"),disabled:y,style:p(e.accentGreen),children:"Approve"}),t.jsx("button",{onClick:()=>_("review","under_review"),disabled:y,style:p(e.accentAmber),children:"Review"}),t.jsx("button",{onClick:()=>_("suspend","suspended"),disabled:y,style:p(e.accentRed),children:"Suspend"}),t.jsx("button",{onClick:()=>_("reinstate","pending"),disabled:y,style:p(e.accentGreen),children:"Reinstate"}),t.jsx("div",{style:{width:"1px",height:"20px",background:e.borderGlass,borderRadius:8}}),t.jsx("button",{onClick:()=>_("delete"),disabled:y,style:p(e.accentRed),children:"Delete"}),t.jsx("button",{onClick:N,style:p(e.textTertiary),children:"Cancel"}),y&&t.jsx("span",{style:{fontFamily:e.mono,fontSize:"10px",color:e.textDim},children:"Processing…"})]})]}),!z&&m.length===0&&t.jsx(re,{icon:X,title:"No Applications Found",description:o?"No applications match your current filter.":"You haven't submitted any certification applications yet."})]})]})}export{ue as BulkImportModal,me as default};
